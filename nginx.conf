events {
    worker_connections 1024;
}

http {
    upstream pocketbase {
        server pocketbase:8090;
    }

    upstream svelte_app {
        server svelte-app:3000;
    }

    server {
        listen 80;
        root /usr/share/nginx/html;  # éœæ…‹æ–‡ä»¶æ ¹ç›®éŒ„
        index index.html;

        # è·¯ç”± /_ åˆ° PocketBase ç®¡ç†é¢æ¿
        location /_ {
            proxy_pass http://pocketbase;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # è·¯ç”± API åˆ° PocketBase
        location /api {
            proxy_pass http://pocketbase;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # WebSocket æ”¯æ´ (for Vite HMR)
        location / {
            proxy_pass http://svelte_app;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # è™•ç†ç†±é‡å•Ÿæ™‚çš„é€£æ¥å•é¡Œ
            proxy_connect_timeout 15s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;
            proxy_next_upstream_tries 10;
            proxy_next_upstream_timeout 60s;

            # å¦‚æœæ‰€æœ‰é‡è©¦éƒ½å¤±æ•—ï¼Œé¡¯ç¤ºç¶­è­·é é¢
            error_page 502 503 504 =200 /maintenance.html;
        }

        # ç¶­è­·é é¢
        location = /maintenance.html {
            internal;
            root /usr/share/nginx/html;
            add_header Content-Type text/html;
            return 200 '<!DOCTYPE html><html><head><title>ç³»çµ±ç¶­è­·ä¸­</title></head><body style="text-align:center;padding:50px;font-family:Arial"><h1>ğŸ”§ ç³»çµ±ç¶­è­·ä¸­</h1><p>æ‡‰ç”¨æ­£åœ¨é‡æ–°å•Ÿå‹•ï¼Œè«‹ç¨å€™...</p><p><small>å¦‚æœé€™å€‹é é¢æŒçºŒé¡¯ç¤ºï¼Œè«‹åˆ·æ–°é é¢</small></p></body></html>';
        }
    }
}
